{% extends 'layouts/base.html.twig' %}

{% block content %}
	<!-- BEGIN PAGE HEADER -->
	<div class="page-header d-print-none">
		<div class="container-xl">
			<div class="row g-2 align-items-center">
				<div class="col">
					<h2 class="page-title">Pengaturan</h2>
				</div>
			</div>
		</div>
	</div>
	<!-- END PAGE HEADER -->
	<!-- BEGIN PAGE BODY -->
	<div class="page-body">
		<div class="container-xl">
			<div class="card">
				<div class="row g-0">
					<div class="col-12 col-md-3 border-end">
						<div class="card-body">
							<h4 class="subheader">Pengaturan Bisnis</h4>
							<div class="list-group list-group-transparent" id="settings-tabs">
								<a href="#akun-saya-tab" class="list-group-item list-group-item-action d-flex align-items-center active" data-bs-toggle="tab">Akun Saya</a>
								<a href="#notifikasi-saya-tab" class="list-group-item list-group-item-action d-flex align-items-center" data-bs-toggle="tab">Notifikasi Saya</a>
								<a href="#visibilitas-akses-tab" class="list-group-item list-group-item-action d-flex align-items-center" data-bs-toggle="tab">Visibilitas & Akses</a>
								<a href="#paket-tab" class="list-group-item list-group-item-action d-flex align-items-center" data-bs-toggle="tab">Paket</a>
								<a href="#tagihan-tab" class="list-group-item list-group-item-action d-flex align-items-center" data-bs-toggle="tab">Tagihan & Faktur</a>
							</div>
							<h4 class="subheader mt-4">Pengalaman</h4>
							<div class="list-group list-group-transparent">
								<a href="#umpan-balik-tab" class="list-group-item list-group-item-action" data-bs-toggle="tab">Beri Umpan Balik</a>
							</div>
						</div>
					</div>
					<div class="col-12 col-md-9 d-flex flex-column">
						<form id="settings-form" action="/api/settings/update" method="post" class="d-flex flex-column flex-grow-1">
							<div class="card-body flex-grow-1">
								{% if error %}
									<div class="alert alert-danger" role="alert">
										{{ error }}
									</div>
								{% endif %}
								<div class="tab-content" id="settings-tab-content">
									<!-- Akun Saya Tab -->
									<div class="tab-pane fade show active" id="akun-saya-tab" role="tabpanel" aria-labelledby="akun-saya-nav">
										<h2 class="mb-4">Akun Saya</h2>
										<h3 class="card-title">Profil Bisnis</h3>
										<div class="row g-3">
											<div class="col-md">
												<div class="form-label">Nama Bisnis</div>
												<input type="text" name="business_name" class="form-control" value="{{ settingsMap.business_name | default('') }}">
											</div>
											<div class="col-md">
												<div class="form-label">Kurir Default</div>
												<select name="default_courier" class="form-select">
													<option value="">Pilih Kurir</option>
													{% for courier in active_couriers %}
														<option value="{{ courier.id }}" {{ courier.id == settingsMap.default_courier ? 'selected' : '' }}>{{ courier.nama }}</option>
													{% endfor %}
												</select>
											</div>
											<div class="col-md">
												<div class="form-label">Ongkir Default (Rp)</div>
												<input type="number" name="default_shipping_cost" class="form-control" value="{{ settingsMap.default_shipping_cost | default('5000') }}">
											</div>
										</div>
									</div>

									<!-- Notifikasi Saya Tab -->
									<div class="tab-pane fade" id="notifikasi-saya-tab" role="tabpanel" aria-labelledby="notifikasi-saya-nav">
										<h2 class="mb-4">Notifikasi Saya</h2>
										<h3 class="card-title">Email Notifikasi</h3>
										<p class="card-subtitle">Email ini akan digunakan untuk menerima notifikasi sistem.</p>
										<div>
											<div class="row g-2">
												<div class="col-auto">
													<input type="email" name="notification_email" class="form-control w-auto" value="{{ settingsMap.notification_email | default(userEmail) }}">
												</div>
											</div>
										</div>
									</div>

									<!-- Visibilitas & Akses Tab -->
									<div class="tab-pane fade" id="visibilitas-akses-tab" role="tabpanel" aria-labelledby="visibilitas-akses-nav">
										<h2 class="mb-4">Visibilitas & Akses</h2>
										<h3 class="card-title">Visibilitas Profil Publik</h3>
										<p class="card-subtitle">Mengaktifkan profil publik memungkinkan orang lain di jaringan melihat bisnis Anda.</p>
										<div>
											<label class="form-check form-switch form-switch-lg">
												<input class="form-check-input" type="checkbox" name="public_profile_visible" {{ settingsMap.public_profile_visible == 'true' ? 'checked' : '' }}>
												<span class="form-check-label form-check-label-on">Anda saat ini terlihat</span>
												<span class="form-check-label form-check-label-off">Anda saat ini tidak terlihat</span>
											</label>
										</div>
									</div>

									<!-- Paket Tab -->
									<div class="tab-pane fade" id="paket-tab" role="tabpanel" aria-labelledby="paket-nav">
										<h2 class="mb-4">Paket</h2>
										<p>Pengaturan Paket belum tersedia.</p>
									</div>

									<!-- Tagihan & Faktur Tab -->
									<div class="tab-pane fade" id="tagihan-tab" role="tabpanel" aria-labelledby="tagihan-nav">
										<h2 class="mb-4">Tagihan & Faktur</h2>
										<p>Pengaturan Tagihan & Faktur belum tersedia.</p>
									</div>

									<!-- Beri Umpan Balik Tab -->
									<div class="tab-pane fade" id="umpan-balik-tab" role="tabpanel" aria-labelledby="umpan-balik-nav">
										<h2 class="mb-4">Beri Umpan Balik</h2>
										<p>Fitur Beri Umpan Balik belum tersedia.</p>
									</div>
								</div>
							</div>
							<div class="card-footer bg-transparent mt-auto">
								<div class="btn-list justify-content-end">
									<a href="/dashboard" class="btn btn-1">Batal</a>
									<button type="submit" form="settings-form" class="btn btn-primary btn-2" id="save-settings-btn">Simpan</button>
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- END PAGE BODY -->

	<!-- Toast Container -->
	<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">
		<div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
			<div class="toast-header">
				<strong class="me-auto" id="toastTitle">Notification</strong>
				<button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
			</div>
			<div class="toast-body" id="toastBody">
				<!-- Message will be inserted here -->
			</div>
		</div>
	</div>

	<script>
	function showToast(message, type = 'success') {
		const toastElement = document.getElementById('liveToast');
		const toastTitleElement = document.getElementById('toastTitle');
		const toastBodyElement = document.getElementById('toastBody');

		if (!toastElement || !toastTitleElement || !toastBodyElement) {
			console.error('Toast elements not found. Falling back to alert.');
			alert(message); // Fallback if toast HTML is missing
			return;
		}

		toastTitleElement.textContent = type === 'success' ? 'Berhasil' : 'Gagal';
		toastBodyElement.textContent = message;

		// Reset classes if you are changing backgrounds based on type
		// For default Bootstrap styling, this might not be needed or might be handled differently.
		// toastElement.classList.remove('bg-success', 'bg-danger', 'text-white');
		// if (type === 'success') {
		//     toastElement.classList.add('bg-success', 'text-white');
		// } else if (type === 'error') {
		//     toastElement.classList.add('bg-danger', 'text-white');
		// }
		// Note: Standard Bootstrap toasts don't typically color the whole toast background via these classes.
		// Header color might be more common if customization is desired beyond default.

		const toast = new bootstrap.Toast(toastElement);
		toast.show();
	}

	document.getElementById('settings-form').addEventListener('submit', async (e) => {
	    e.preventDefault();
	    const form = e.target;
	    const formData = new FormData(form);
	    const data = Object.fromEntries(formData);

	    const saveButton = document.getElementById('save-settings-btn');
	    const originalButtonText = saveButton.innerHTML;
	    saveButton.disabled = true;
	    saveButton.innerHTML = 'Menyimpan... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
	
	    try {
	        const response = await fetch(form.action, {
	            method: 'POST',
	            headers: {
	                'Content-Type': 'application/json',
	                'X-Requested-With': 'XMLHttpRequest'
	            },
	            body: JSON.stringify(data)
	        });
	        const result = await response.json();
	
	        if (result.success) {
	            showToast('Pengaturan berhasil disimpan', 'success');
	        } else {
	            showToast('Gagal menyimpan pengaturan: ' + (result.message || 'Tidak ada pesan error spesifik.'), 'error');
	        }
	    } catch (error) {
	        console.error('Error submitting settings:', error);
	        showToast('Terjadi kesalahan saat menyimpan pengaturan. Silakan coba lagi.', 'error');
	    } finally {
	        saveButton.disabled = false;
	        saveButton.innerHTML = originalButtonText;
	    }
	});
	</script>
{% endblock %}
