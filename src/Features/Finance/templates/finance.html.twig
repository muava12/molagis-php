{% extends 'layouts/base.html.twig' %}

{% block title %}{{ title }} - Catering Molagis{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <link rel="stylesheet" href="/css/flatpickr.min.css">
  <style>
    .summary-card {
      border-left: 4px solid var(--tblr-primary);
    }
    .category-badge {
      font-size: 0.75rem;
    }
    .amount-cell {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      font-weight: 600;
    }
  </style>
{% endblock %}

{% block content %}
  <!-- Page Header -->
  <div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <div class="page-pretitle">Management</div>
          <h2 class="page-title">ðŸ’° Finance</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Page Body -->
  <div class="page-body">
    <div class="container-xl">
      {% if categories_error or summary_error or records_error %}
        <div class="alert alert-danger" role="alert">
          <h4 class="alert-title">Error Occurred!</h4>
          <div class="text-secondary">
            {% if categories_error %}{{ categories_error }}<br>{% endif %}
            {% if summary_error %}{{ summary_error }}<br>{% endif %}
            {% if records_error %}{{ records_error }}{% endif %}
          </div>
        </div>
      {% endif %}

      <div class="row">
        <!-- Left Column: Input Form -->
        <div class="col-lg-4 mb-4">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M12 5l0 14"/>
                  <path d="M5 12l14 0"/>
                </svg>
                Add Expense
              </h3>
            </div>
            <div class="card-body">
              <form id="expense-form">
                <div class="mb-3">
                  <label for="transaction-date" class="form-label">Transaction Date</label>
                  <input type="text" class="form-control" id="transaction-date" name="transaction_date" placeholder="Select date" required>
                </div>

                <div class="mb-3">
                  <label for="category-select" class="form-label">Category</label>
                  <select class="form-select" id="category-select" name="category_id" required>
                    <option value="" disabled selected>Select category</option>
                    {% for category in categories %}
                      <option value="{{ category.id }}">{{ category.display_name }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="mb-3">
                  <label for="amount-input" class="form-label">Amount (Rp)</label>
                  <input type="number" class="form-control" id="amount-input" name="amount" placeholder="Enter amount" min="0" step="1" required>
                </div>

                <div class="mb-3">
                  <label for="description-input" class="form-label">Description</label>
                  <textarea class="form-control" id="description-input" name="description" placeholder="Optional description" rows="3"></textarea>
                </div>

                <div class="d-grid">
                  <button type="submit" class="btn btn-primary" id="submit-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                      <path d="M5 12l5 5l10 -10"/>
                    </svg>
                    <span class="btn-text">Save Transaction</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Quick Categories -->
          <div class="card mt-3">
            <div class="card-header">
              <h3 class="card-title">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M9 12l2 2l4 -4"/>
                  <path d="M21 12c0 4.97 -4.03 9 -9 9s-9 -4.03 -9 -9s4.03 -9 9 -9s9 4.03 9 9"/>
                </svg>
                Quick Categories
              </h3>
            </div>
            <div class="card-body">
              <div class="d-grid gap-2">
                {% for category in categories|slice(0, 5) %}
                  <button type="button" class="btn btn-outline-secondary btn-sm quick-category-btn" data-category-id="{{ category.id }}" data-category-name="{{ category.display_name }}">
                    {{ category.display_name }}
                  </button>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column: Summary & History -->
        <div class="col-lg-8">
          <!-- Summary Cards -->
          <div class="row mb-4">
            <div class="col-sm-6 mb-3">
              <div class="card summary-card">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="subheader">Total Expenses This Month</div>
                    <div class="ms-auto lh-1">
                      <div class="h3 m-0 amount-cell text-danger">
                        Rp {{ summary.total_expenses | default(0) | number_format(0, ',', '.') }}
                      </div>
                    </div>
                  </div>
                  <div class="d-flex align-items-baseline">
                    <div class="h1 me-2">ðŸ“Š</div>
                    <div class="me-auto">
                      <span class="text-green d-inline-flex align-items-center lh-1">
                        {{ summary.total_records | default(0) }} transactions
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-sm-6 mb-3">
              <div class="card">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="subheader">Period</div>
                    <div class="ms-auto lh-1">
                      <div class="h5 m-0">
                        {% if summary.period %}
                          {{ summary.period.start_date | date('d/m') }} - {{ summary.period.end_date | date('d/m/Y') }}
                        {% else %}
                          This Month
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  <div class="d-flex align-items-baseline">
                    <div class="h1 me-2">ðŸ“…</div>
                    <div class="me-auto">
                      <span class="text-muted d-inline-flex align-items-center lh-1">
                        Active filter
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Filters -->
          <div class="card mb-4">
            <div class="card-header">
              <h3 class="card-title">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M5.5 5h13a1 1 0 0 1 0.5 1.5l-5 5.5l0 7l-4 -3l0 -4l-5 -5.5a1 1 0 0 1 0.5 -1.5"/>
                </svg>
                Filter Transactions
              </h3>
            </div>
            <div class="card-body">
              <form id="filter-form">
                <div class="row g-3 mb-3">
                  <div class="col-md-4">
                    <label for="filter-start-date" class="form-label">From Date</label>
                    <input type="text" class="form-control" id="filter-start-date" name="start_date" placeholder="Select start date" value="{{ current_start_date }}">
                  </div>
                  <div class="col-md-4">
                    <label for="filter-end-date" class="form-label">To Date</label>
                    <input type="text" class="form-control" id="filter-end-date" name="end_date" placeholder="Select end date" value="{{ current_end_date }}">
                  </div>
                  <div class="col-md-4">
                    <label for="filter-category" class="form-label">Category</label>
                    <select class="form-select" id="filter-category" name="category_id">
                      <option value="">All Categories</option>
                      {% for category in categories %}
                        <option value="{{ category.id }}" {{ current_category_id == category.id ? 'selected' : '' }}>{{ category.display_name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>

                <div class="row g-2">
                  <div class="col">
                    <div class="row g-2">
                      <div class="col-auto">
                        <button type="submit" class="btn btn-primary" id="filter-btn">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"/>
                            <path d="M21 21l-6 -6"/>
                          </svg>
                          <span class="btn-text">Filter</span>
                          <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                      </div>
                      <div class="col-auto">
                        <button type="button" class="btn btn-secondary" id="clear-filter-btn">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M18 6l-12 12"/>
                            <path d="M6 6l12 12"/>
                          </svg>
                          Reset
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <!-- Transaction History -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M9 5h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2h-2"/>
                  <path d="M9 3m0 2a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v0a2 2 0 0 1 -2 2h-2a2 2 0 0 1 -2 -2z"/>
                  <path d="M9 12l2 2l4 -4"/>
                </svg>
                Transaction History
              </h3>
            </div>
            <div class="table-responsive">
              <table class="table table-vcenter card-table" id="records-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Category</th>
                    <th>Description</th>
                    <th class="text-end">Amount</th>
                    <th class="w-1">Actions</th>
                  </tr>
                </thead>
                <tbody id="records-tbody">
                  {% for record in records %}
                    <tr data-record-id="{{ record.id }}">
                      <td>
                        <div class="text-muted">{{ record.transaction_date | date('d/m/Y') }}</div>
                        <div class="text-muted small">{{ record.created_at | date('H:i') }}</div>
                      </td>
                      <td>
                        <span class="badge category-badge bg-secondary-lt">
                          {{ record.expense_categories.display_name | default('Other') }}
                        </span>
                      </td>
                      <td>
                        <div class="text-truncate" style="max-width: 200px;" title="{{ record.description }}">
                          {{ record.description | default('-') }}
                        </div>
                      </td>
                      <td class="text-end amount-cell text-danger">
                        Rp {{ record.amount | number_format(0, ',', '.') }}
                      </td>
                      <td>
                        <div class="btn-list flex-nowrap">
                          <button class="btn btn-sm btn-outline-primary edit-record-btn" data-record-id="{{ record.id }}" title="Edit">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                              <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1"/>
                              <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z"/>
                              <path d="M16 5l3 3"/>
                            </svg>
                          </button>
                          <button class="btn btn-sm btn-outline-danger delete-record-btn" data-record-id="{{ record.id }}" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                              <path d="M4 7l16 0"/>
                              <path d="M10 11l0 6"/>
                              <path d="M14 11l0 6"/>
                              <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"/>
                              <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"/>
                            </svg>
                          </button>
                        </div>
                      </td>
                    </tr>
                  {% else %}
                    <tr>
                      <td colspan="5" class="text-center text-muted py-4">
                        <div class="empty">
                          <div class="empty-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                              <path d="M14 3v4a1 1 0 0 0 1 1h4"/>
                              <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"/>
                              <path d="M10 12l4 4m0 -4l-4 4"/>
                            </svg>
                          </div>
                          <p class="empty-title">No transactions yet</p>
                          <p class="empty-subtitle text-muted">
                            Start adding expense transactions using the form on the left.
                          </p>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="card-footer d-flex align-items-center">
              <p class="m-0 text-secondary" id="records-info">
                Showing {{ records|length }} transactions
              </p>
              <ul class="pagination m-0 ms-auto" id="pagination">
                <!-- Pagination will be handled by JavaScript -->
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  {% include 'toast.html.twig' %}
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script src="/js/flatpickr.min.js"></script>
  <script src="/js/flatpickr-l10n/id.js"></script>
  <script type="module" src="/js/app/finance.js?v={{ 'now'|date('U') }}"></script>
{% endblock %}
