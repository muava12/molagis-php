{% if selected_customer_id %}
    {% set has_data_to_display = false %}
    {% if current_grouping == 'order_id' %}
        {% if grouped_deliveries is not empty %}
            {% set has_data_to_display = true %}
        {% endif %}
    {% else %} {# 'none' grouping or other non-grouped views #}
        {% if deliveries is not empty %}
            {% set has_data_to_display = true %}
        {% endif %}
    {% endif %}

    {% if not has_data_to_display %}
        <div class="empty-state-card text-center py-5"> {# Ensure this class is defined in CSS later #}
            <div style="width: 200px; height: 200px;">
                {% include 'svg/bird.svg.twig' %}
            </div>
            <p class="mt-3">Tidak ada data untuk ditampilkan.</p>
        </div>
    {% else %}
        <h3 class="card-title mt-4 mb-2">Rincian Pesanan</h3>

        {% if current_grouping == 'order_id' %}
            {# grouped_deliveries is guaranteed not empty here by has_data_to_display check #}
            <div class="accordion accordion-tabs" id="ordersAccordionParent"> {# Main accordion container #}
                {% for order_item in grouped_deliveries %}
                    <div class="accordion-item">
                        <div class="accordion-header" id="heading-order-{{ order_item.id }}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-order-{{ order_item.id }}" aria-expanded="false" aria-controls="collapse-order-{{ order_item.id }}">
                                <div class="flex-grow-1">
                                    <div class="fw-bold mb-1">Order ID: {{ order_item.id }}</div>
                                    <div class="small">
                                        <span>Tgl Pesan: {{ order_item.tanggal_pesan | date("d M Y") }}</span>
                                        <span class="mx-2">|</span>
                                        <span>Total: Rp {{ order_item.total_harga | number_format(0, ',', '.') }}</span>
                                    </div>
                                    {% if order_item.notes %}
                                        <div class="text-muted small mt-1">
                                            Catatan Order: {{ order_item.notes }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="accordion-button-toggle">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1"><path d="M6 9l6 6l6 -6"></path></svg>
                                </div>
                            </button>
                        </div>
                        <div id="collapse-order-{{ order_item.id }}" class="accordion-collapse collapse" aria-labelledby="heading-order-{{ order_item.id }}" data-bs-parent="#ordersAccordionParent">
                            <div class="accordion-body">
                                <div class="table-responsive">
                                    <table class="table table-vcenter card-table table-selectable table-sm"> {# Added table-sm for compactness #}
                                        <thead>
                                            <tr>
                                                <th><input class="form-check-input m-0 align-middle select-delivery-group-master" type="checkbox" aria-label="Select all deliveries for this order" data-order-id="{{ order_item.id }}"></th>
                                                <th>Tgl Kirim</th>
                                                <th>Details</th>
                                                <th>Kurir</th>
                                                <th>Ongkir</th>
                                                <th>Total</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% if order_item.deliverydates is not empty %}
                                                {% for delivery in order_item.deliverydates %}
                                                    <tr>
                                                        <td><input class="form-check-input m-0 align-middle select-delivery-item" type="checkbox" value="{{ delivery.delivery_id }}" aria-label="Select delivery {{ delivery.delivery_id }}" data-order-group="{{ order_item.id }}"></td>
                                                        <td>{{ delivery.tanggal | date("d M Y") }}</td>
                                                        <td>
                                                            {# Show table if there are package items or additional items #}
                                                            {% if delivery.orderdetails is not empty or delivery.item_tambahan %}
                                                                <table class="table table-sm table-borderless mb-0">
                                                                    <tbody>
                                                                        {# Package items #}
                                                                        {% if delivery.orderdetails is not empty %}
                                                                            {% for detail_item in delivery.orderdetails %}
                                                                                <tr>
                                                                                    <td>{{ detail_item.paket.nama | default('N/A') }}</td>
                                                                                    <td>({{ detail_item.jumlah }})</td>
                                                                                    <td class="text-end">{{ detail_item.subtotal_harga | number_format(0, ',', '.') }}</td>
                                                                                </tr>
                                                                                {% if detail_item.catatan_dapur %}
                                                                                    <tr><td colspan="3"><small class="text-muted"><em>Dapur: {{ detail_item.catatan_dapur }}</em></small></td></tr>
                                                                                {% endif %}
                                                                                {% if detail_item.catatan_kurir %}
                                                                                    <tr><td colspan="3"><small class="text-muted"><em>Kurir: {{ detail_item.catatan_kurir }}</em></small></td></tr>
                                                                                {% endif %}
                                                                            {% endfor %}
                                                                        {% endif %}

                                                                        {# Additional items #}
                                                                        {% if delivery.item_tambahan %}
                                                                            <tr>
                                                                                <td>{{ delivery.item_tambahan }} <span class="text-success">+</span></td>
                                                                                <td></td>
                                                                                <td class="text-end">{% if delivery.harga_tambahan is not null and delivery.harga_tambahan > 0 %}{{ delivery.harga_tambahan | number_format(0, ',', '.') }}{% endif %}</td>
                                                                            </tr>
                                                                        {% endif %}
                                                                    </tbody>
                                                                </table>
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if delivery.couriers.nama and delivery.couriers.nama != '-' %}
                                                                {% set courier_colors = ['blue', 'azure', 'indigo', 'purple', 'pink', 'red', 'orange', 'yellow', 'lime', 'green', 'teal', 'cyan'] %}
                                                                {% set clean_name = delivery.couriers.nama | lower | replace({' ': '', '-': '', '_': ''}) %}
                                                                {% set name_length = clean_name | length %}
                                                                {% set color_index = name_length % (courier_colors | length) %}
                                                                {% set courier_color = courier_colors[color_index] %}
                                                                <span class="badge bg-{{ courier_color }}-lt">{{ delivery.couriers.nama }}</span>
                                                            {% else %}
                                                                <span class="badge bg-default-lt">-</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>{{ delivery.ongkir | number_format(0, ',', '.') }}</td>
                                                        <td>{{ delivery.total_harga_perhari | number_format(0, ',', '.') }}</td>
                                                        <td class="text-nowrap">
                                                            {% set status_lower = delivery.status | lower %}
                                                            {% set badge_class = 'secondary' %}
                                                            {% if status_lower == 'completed' %}{% set badge_class = 'success' %}
                                                            {% elseif status_lower == 'pending' %}{% set badge_class = 'warning' %}
                                                            {% elseif status_lower == 'canceled' or status_lower == 'cancelled' %}{% set badge_class = 'danger' %}
                                                            {% elseif status_lower == 'in-progress' or status_lower == 'in_progress' %}{% set badge_class = 'info' %}
                                                            {% endif %}
                                                            <span class="badge bg-{{ badge_class }} me-1"></span>{{ delivery.status | replace({'_': ' '}) | title }}
                                                        </td>
                                                        <td>
                                                            <div class="btn-list flex-nowrap">
                                                                <button class="btn btn-sm btn-icon edit-delivery-btn" data-delivery-id="{{ delivery.delivery_id }}" title="Edit Pengiriman">
                                                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1" /><path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z" /><path d="M16 5l3 3" /></svg>
                                                                </button>
                                                                <button class="btn btn-sm btn-icon text-danger delete-delivery-btn" data-delivery-id="{{ delivery.delivery_id }}" title="Hapus Pengiriman">
                                                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-trash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7l16 0" /><path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" /></svg>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr><td colspan="8" class="text-center">Tidak ada data pengiriman untuk order ini.</td></tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div> {# End of table-responsive #}
                            </div> {# End of accordion-body #}
                        </div> {# End of accordion-collapse #}
                    </div> {# End of accordion-item #}
                {% endfor %}
            </div> {# End of ordersAccordionParent #}
        {% else %} {# 'none' grouping or default, deliveries is guaranteed not empty here #}
            <div class="card-table table-responsive">
                <table class="table table-vcenter card-table table-selectable">
                    <thead>
                        <tr>
                            <th><input class="form-check-input m-0 align-middle" type="checkbox" id="select-all-deliveries" aria-label="Select all deliveries"></th>
                            <th>Tanggal</th>
                            <th>Details</th>
                            <th>Kurir</th>
                            <th>Ongkir</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {# deliveries is guaranteed not empty here by has_data_to_display check #}
                        {% for delivery in deliveries %}
                            <tr>
                                <td><input class="form-check-input m-0 align-middle select-delivery-item" type="checkbox" value="{{ delivery.delivery_id }}" aria-label="Select delivery {{ delivery.delivery_id }}"></td>
                                <td>{{ delivery.delivery_tanggal | date("d M Y") }}</td>
                                <td>
                                    {# Show table if there are package items or additional items #}
                                    {% if delivery.details is not empty or delivery.item_tambahan %}
                                        <table class="table table-sm table-borderless mb-0">
                                            <tbody>
                                                {# Package items #}
                                                {% if delivery.details is not empty %}
                                                    {% for detail_item in delivery.details %}
                                                        <tr>
                                                            <td>{{ detail_item.paket.nama | default('N/A') }}</td>
                                                            <td>({{ detail_item.jumlah }})</td>
                                                            <td class="text-end">{{ detail_item.subtotal_harga | number_format(0, ',', '.') }}</td>
                                                        </tr>
                                                        {% if detail_item.catatan_dapur %}
                                                            <tr><td colspan="3"><small class="text-muted"><em>Dapur: {{ detail_item.catatan_dapur }}</em></small></td></tr>
                                                        {% endif %}
                                                        {% if detail_item.catatan_kurir %}
                                                            <tr><td colspan="3"><small class="text-muted"><em>Kurir: {{ detail_item.catatan_kurir }}</em></small></td></tr>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}

                                                {# Additional items #}
                                                {% if delivery.item_tambahan %}
                                                    <tr>
                                                        <td>{{ delivery.item_tambahan }} <span class="text-success">+</span></td>
                                                        <td></td>
                                                        <td class="text-end">{% if delivery.harga_tambahan is not null and delivery.harga_tambahan > 0 %}{{ delivery.harga_tambahan | number_format(0, ',', '.') }}{% endif %}</td>
                                                    </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>
                                    {% if delivery.courier_nama and delivery.courier_nama != '-' %}
                                        {% set courier_colors = ['blue', 'azure', 'indigo', 'purple', 'pink', 'red', 'orange', 'yellow', 'lime', 'green', 'teal', 'cyan'] %}
                                        {% set clean_name = delivery.courier_nama | lower | replace({' ': '', '-': '', '_': ''}) %}
                                        {% set name_length = clean_name | length %}
                                        {% set color_index = name_length % (courier_colors | length) %}
                                        {% set courier_color = courier_colors[color_index] %}
                                        <span class="badge bg-{{ courier_color }}-lt">{{ delivery.courier_nama }}</span>
                                    {% else %}
                                        <span class="badge bg-default-lt">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ delivery.delivery_ongkir | number_format(0, ',', '.') }}</td>
                                <td>{{ delivery.total_harga_perhari | number_format(0, ',', '.') }}</td>
                                <td class="text-nowrap">
                                    {% set status_lower = delivery.delivery_status | lower %}
                                    {% set badge_class = 'secondary' %}
                                    {% if status_lower == 'completed' %}{% set badge_class = 'success' %}
                                    {% elseif status_lower == 'pending' %}{% set badge_class = 'warning' %}
                                    {% elseif status_lower == 'canceled' or status_lower == 'cancelled' %}{% set badge_class = 'danger' %}
                                    {% elseif status_lower == 'in-progress' or status_lower == 'in_progress' %}{% set badge_class = 'info' %}
                                    {% endif %}
                                    <span class="badge bg-{{ badge_class }} me-1"></span>{{ delivery.delivery_status | replace({'_': ' '}) | title }}
                                </td>
                                <td>
                                    <div class="btn-list flex-nowrap">
                                        <button class="btn btn-sm btn-icon edit-delivery-btn" data-delivery-id="{{ delivery.delivery_id }}" title="Edit Pengiriman">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1" /><path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z" /><path d="M16 5l3 3" /></svg>
                                        </button>
                                        <button class="btn btn-sm btn-icon text-danger delete-delivery-btn" data-delivery-id="{{ delivery.delivery_id }}" title="Hapus Pengiriman">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-trash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7l16 0" /><path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" /></svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %} {# End of the main if current_grouping == 'order_id' else ... #}

        {# Pagination and Items Per Page - this div should be outside the conditional grouping block #}
        <div class="d-flex align-items-center mt-3">
            {% if view == 'by_name' and selected_customer_id and allowed_limits is defined and current_limit is defined %}
            <div class="me-3">
                <label for="items_per_page_select" class="form-label visually-hidden">Items per page</label>
                <select class="form-select" id="items_per_page_select" style="width: auto;">
                    {% for limit_option in allowed_limits %}
                        <option value="{{ limit_option }}" {{ limit_option == current_limit ? 'selected' : '' }}>
                            {{ limit_option }} per page
                        </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            <div class="text-muted ms-auto">
                {% if view == 'by_name' and selected_customer_id and total_pages is defined and total_pages > 0 %}
                <ul class="pagination m-0">
                    <li class="page-item {{ current_page == 1 ? 'disabled' : '' }}">
                        <a class="page-link" href="{{ current_page == 1 ? '#' : ('/orders?view=by_name&customer_id=' ~ selected_customer_id ~ '&page=' ~ (current_page - 1) ~ '&limit=' ~ current_limit ~ '&grouping=' ~ current_grouping) }}" {{ current_page == 1 ? 'tabindex="-1" aria-disabled="true"' : '' }}>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon">
                                <path d="M15 6l-6 6l6 6"></path>
                            </svg>
                        </a>
                    </li>
                    {% for i in 1..total_pages %}
                    <li class="page-item {{ (i == current_page or total_pages == 1) ? 'active' : '' }}" {{ (i == current_page or total_pages == 1) ? 'aria-current="page"' : '' }}>
                        {% if total_pages == 1 %}
                        <span class="page-link">{{ i }}</span>
                        {% else %}
                        <a class="page-link" href="{{ '/orders?view=by_name&customer_id=' ~ selected_customer_id ~ '&page=' ~ i ~ '&limit=' ~ current_limit ~ '&grouping=' ~ current_grouping }}">{{ i }}</a>
                        {% endif %}
                    </li>
                    {% endfor %}
                    <li class="page-item {{ current_page == total_pages ? 'disabled' : '' }}">
                        <a class="page-link" href="{{ current_page == total_pages ? '#' : ('/orders?view=by_name&customer_id=' ~ selected_customer_id ~ '&page=' ~ (current_page + 1) ~ '&limit=' ~ current_limit ~ '&grouping=' ~ current_grouping) }}" {{ current_page == total_pages ? 'tabindex="-1" aria-disabled="true"' : '' }}>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon">
                                <path d="M9 6l6 6l-6 6"></path>
                            </svg>
                        </a>
                    </li>
                </ul>
                {% else %}
                <ul class="pagination m-0">
                    <li class="page-item disabled">
                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
                                <path d="M15 6l-6 6l6 6"></path>
                            </svg>
                        </a>
                    </li>
                    <li class="page-item disabled"><a class="page-link" href="#">1</a></li>
                    <li class="page-item disabled">
                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
                                <path d="M9 6l6 6l-6 6"></path>
                            </svg>
                        </a>
                    </li>
                </ul>
                {% endif %}
            </div>
        </div>
    {% endif %} {# End of if not has_data_to_display else ... #}
{% else %}
    {# This part is intentionally left as is, for when no customer is selected.
       The main order-list.html.twig template shows a message in this case. #}
{% endif %}
