{% extends "base.html.twig" %}

{% block title %}{{ title | default("Riwayat Pengiriman Pelanggan") }}{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <link rel="stylesheet" href="/css/flatpickr.min.css">
  <link rel="stylesheet" href="/css/app/awesomplete.css" />
  <link rel="stylesheet" href="/css/app/input-order-page.css?v={{ 'now'|date('U') }}">
{% endblock %}

{% block content %}
<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <h2 class="page-title">
          {{ title | default("Riwayat Pengiriman Pelanggan") }}
        </h2>
      </div>
      <div class="col-auto ms-auto d-print-none">
        <div class="btn-list">
          <!-- Tombol Create new order - Desktop -->
          <a href="#" class="btn btn-primary btn-5 d-none d-sm-inline-block" data-bs-toggle="modal" data-bs-target="#modal-add-order">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-shopping-cart-plus">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M4 19a2 2 0 1 0 4 0a2 2 0 0 0 -4 0"/>
                  <path d="M12.5 17h-6.5v-14h-2"/>
                  <path d="M6 5l14 1l-.86 6.017m-2.64 .983h-10.5"/>
                  <path d="M16 19h6"/>
                  <path d="M19 16v6"/>
              </svg>
              Input Pesanan
          </a>
          <!-- Tombol Create new order - Mobile -->
          <a href="#" class="btn btn-primary btn-6 d-sm-none btn-icon" data-bs-toggle="modal" data-bs-target="#modal-add-order" aria-label="Create new report">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-shopping-cart-plus">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M4 19a2 2 0 1 0 4 0a2 2 0 0 0 -4 0"/>
                  <path d="M12.5 17h-6.5v-14h-2"/>
                  <path d="M6 5l14 1l-.86 6.017m-2.64 .983h-10.5"/>
                  <path d="M16 19h6"/>
                  <path d="M19 16v6"/>
              </svg>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="page-body">
  <div class="container-xl">
    <div class="card">
      <div class="card-header">
  <h3 class="card-title d-flex align-items-center">
    {% if selected_customer_name and selected_customer_name is not empty %}
      {# Ensure selected_customer_id is available in this template context.
         If it's not, this might render incorrectly or throw an error.
         Assuming selected_customer_id holds the customer's ID. #}
      <span class="avatar avatar-sm me-2" style="background-image: url(https://api.dicebear.com/9.x/avataaars-neutral/svg?seed={{ selected_customer_id | default('defaultSeed') }}&scale=90&backgroundColor=ae5d29,d08b5b,edb98a,fd9841,ffdbb4,f8d25c&backgroundRotation=0,360,50,40,80,110&eyebrows=angryNatural,default,defaultNatural,flatNatural,raisedExcited,raisedExcitedNatural,sadConcerned,sadConcernedNatural,unibrowNatural,upDown,upDownNatural,angry&eyes=cry,default,eyeRoll,happy,side,squint,surprised,wink,winkWacky&mouth=concerned,default,disbelief,eating,grimace,sad,screamOpen,serious,smile,tongue,twinkle);"></span>
      {{ selected_customer_name }}
    {% else %}
      Manajemen Pesanan
    {% endif %}
  </h3>
        <div class="ms-auto">
          <nav class="nav nav-segmented" role="tablist" id="orders-view-tabs">
              <button type="button" class="nav-link {{ (view == 'by_name' or view is null or view == '') ? 'active' : '' }}" id="tab-by-name-button" data-bs-toggle="tab" data-bs-target="#pane-by-name" role="tab" aria-controls="pane-by-name" aria-selected="{{ (view == 'by_name' or view is null or view == '') ? 'true' : 'false' }}">
                  <!-- SVG for List icon -->
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon nav-link-icon icon-2">
                    <path d="M9 6l11 0"></path>
                    <path d="M9 12l11 0"></path>
                    <path d="M9 18l11 0"></path>
                    <path d="M5 6l0 .01"></path>
                    <path d="M5 12l0 .01"></path>
                    <path d="M5 18l0 .01"></path>
                  </svg>
                  <span class="d-none d-sm-inline">By Name</span>
              </button>
              <button type="button" class="nav-link {{ view == 'by_date' ? 'active' : '' }}" id="tab-by-date-button" data-bs-toggle="tab" data-bs-target="#pane-by-date" role="tab" aria-controls="pane-by-date" aria-selected="{{ view == 'by_date' ? 'true' : 'false' }}">
                  <!-- SVG for Calendar icon -->
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon nav-link-icon icon-2">
                    <path d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z"></path>
                    <path d="M16 3v4"></path>
                    <path d="M8 3v4"></path>
                    <path d="M4 11h16"></path>
                    <path d="M11 15h1"></path>
                    <path d="M12 15v3"></path>
                  </svg>
                  <span class="d-none d-sm-inline">By Date</span>
              </button>
              {# Example of a disabled tab as in user's reference - adapt if needed, or remove if not applicable #}
              {# <button type="button" class="nav-link disabled" role="tab" data-bs-toggle="tab" aria-selected="false" aria-disabled="true" tabindex="-1">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon nav-link-icon icon-2">
                  </svg>
                  Other (Disabled)
              </button> #}
          </nav>
        </div>
      </div>
      {# New Control Bar - Below the card-header with tabs, but before the card-body with tab-content #}
      <div class="card-body border-bottom py-3">
        <div class="d-flex">
          {# This div.text-muted was the container for pagination, now removed from here. #}
          <div class="ms-auto d-flex align-items-center"> {# Search Area - aligned right #}

            {# NEW GROUPING DROPDOWN START #}
            <div class="me-3">
              <label for="grouping_select" class="form-label visually-hidden">Group By</label>
              <select class="form-select" id="grouping_select" style="width: auto;">
                  <option value="none" {% if current_grouping == 'none' or current_grouping is null %}selected{% endif %}>No Grouping</option>
                  <option value="order_id" {% if current_grouping == 'order_id' %}selected{% endif %}>Group by Order ID</option>
              </select>
            </div>
            {# NEW GROUPING DROPDOWN END #}

            {# Form for "By Name" - initial style set by JS based on 'view' variable #}
            <form method="GET" action="/orders" class="mb-0 me-2" id="form_search_by_name" style="display: {{ (view == 'by_name' or view is null or view == '') ? 'flex' : 'none' }};">
              <input type="hidden" name="view" value="by_name">
              <div class="row g-2">
                <div class="col-auto">
                  <label for="customer_search_orders" class="visually-hidden">Pelanggan</label>
                  <div class="input-icon">
                    <input type="text" id="customer_search_orders" class="form-control" placeholder="Ketik nama pelanggan..." value="">
                    <span class="input-icon-addon">
                      <!-- Default to showing the search icon -->
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
                        <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"></path>
                        <path d="M21 21l-6 -6"></path>
                      </svg>
                    </span>
                  </div>
                  <input type="hidden" name="customer_id" id="selected_customer_id_hidden" value="{{ selected_customer_id | default('') }}">
                </div>
              </div>
            </form>

            {# Form for "By Order ID" - initial style set by JS based on 'view' variable #}
            <form id="form_search_by_order_id" class="mb-0 me-2" style="display: {{ view == 'by_order_id' ? 'flex' : 'none' }};">
              <input type="hidden" name="view" value="by_order_id">
              <div class="row g-2">
                <div class="col-auto">
                  <label for="order_id_search_input" class="visually-hidden">Order ID</label>
                  <input type="text" class="form-control" id="order_id_search_input" placeholder="Masukkan ID Pesanan..." value="{{ order_id_query_value | default('') }}">
                </div>
                <div class="col-auto">
                  <button type="button" class="btn btn-primary" id="order_id_search_button">Cari Order</button>
                </div>
              </div>
            </form>

            {# Form for "By Date" - initial style set by JS based on 'view' variable #}
            <form id="form_search_by_date" class="mb-0" style="display: {{ view == 'by_date' ? 'show' : 'none' }};">
              <input type="hidden" name="view" value="by_date">
              <div class="row g-2">
                <div class="col-auto">
                  <label for="delivery_date_search_input" class="visually-hidden">Tanggal Pengiriman</label>
                  <div class="input-icon">
                    <input type="text" class="form-control" id="delivery_date_search_input" placeholder="Pilih tanggal..." value="{{ default_date | default('') }}">
                    <span class="input-icon-addon">
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z"></path><path d="M16 3v4"></path><path d="M8 3v4"></path><path d="M4 11h16"></path><path d="M11 15h1"></path><path d="M12 15v3"></path></svg>
                    </span>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="tab-content" id="orders-tab-content">
          <div class="tab-pane fade {{ view == 'by_name' or view is null or view == '' ? 'show active' : '' }}" id="pane-by-name" role="tabpanel" aria-labelledby="tab-by-name-button">
            <div id="orders-by-name-content-wrapper">
                {% if selected_customer_id %}
                    {# This content is now rendered by _orders_table_partial.html.twig #}
                    {% include '_orders_table_partial.html.twig' %}
                {% else %}
                    {% if view == 'by_name' or view is null or view == '' %}
                        <div class="alert alert-info" role="alert">
                            Silakan pilih atau cari pelanggan untuk melihat riwayat pengiriman.
                        </div>
                    {% endif %}
                {% endif %}
            </div>
          </div>

          <div class="tab-pane fade {{ view == 'by_order_id' ? 'show active' : '' }}" id="pane-by-order-id" role="tabpanel" aria-labelledby="tab-by-order-id-button">
            {# Order ID search form was moved to control bar #}
            <div id="order_id_search_results_container">
              {# Search results or messages will be injected here by JavaScript #}
              {% if not order_id_query_value and view == 'by_order_id' %}
      <p class="text-muted py-5 text-center">Masukkan ID Pesanan di atas untuk memulai pencarian.</p> {# Added some padding and centering for consistency #}
    {% elseif order_id_query_value and orders_by_id_result is not empty %}
      {# This is the case where results are found and displayed #}
                {% for order in orders_by_id_result %}
                  {% if order %} {# Check if order data is not null #}
                    <div class="card mt-3">
                        <div class="card-header"><h3 class="card-title">Order Details (ID: {{ order.id }})</h3></div>
                        <div class="card-body">
                            <p><strong>Customer:</strong> {{ order.customers.nama | default('N/A') }}</p>
                            <p><strong>Order Date:</strong> {{ order.tanggal_pesan | date("d M Y") }}</p>
                            <p><strong>Total:</strong> {{ order.total_harga | number_format(0, ',', '.') }}</p>
                            <p><strong>Payment Method:</strong> {{ order.metode_pembayaran | replace({'_': ' '}) | title }}</p>
                            <p><strong>Notes:</strong> {{ order.notes | default('-') }}</p>
                        </div>
                    </div>
                  {% endif %}
                {% endfor %}
    {% elseif order_id_query_value and (orders_by_id_result is empty or orders_by_id_result is null) and view == 'by_order_id' %}
      {# This is the case where a search was made (order_id_query_value exists) but no results were found #}
      <div class="empty-state-card text-center py-5"> {# Use common class for styling #}
          <div style="width: 200px; height: 200px; margin: 0 auto 1rem auto;">
              {% include 'svg/bird.svg.twig' %}
          </div>
          <p class="mt-3">Pencarian tidak menemukan data.</p>
      </div>
              {% endif %}
    {# Note: JavaScript might also inject content or messages here, especially if the search happens client-side after page load.
       The above Twig logic handles server-rendered states. #}
            </div>
          </div>

          <div class="tab-pane fade {{ view == 'by_date' ? 'show active' : '' }}" id="pane-by-date" role="tabpanel" aria-labelledby="tab-by-date-button">
            {# Date search form was moved to control bar #}
            <div id="delivery_date_search_results_container">
    {# Server-side rendering for initial 'by_date' view #}
    {% if view == 'by_date' %}
        {% if deliveries_for_today is defined and deliveries_for_today is not empty %}
            <div class="table-responsive">
                <table class="table table-vcenter card-table table-striped">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Order ID</th>
                            <th>Items</th>
                            <th>Notes (Dapur/Kurir)</th>
                            <th>Kurir</th>
                            <th>Pembayaran</th>
                            <th>Ongkir</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th class="w-1">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for delivery in deliveries_for_today %}
                            <tr id="delivery-row-{{ delivery.delivery_id }}">
                                <td>{{ delivery.customer_name | default('N/A') }}</td>
                                <td>
                                    <a href="/orders?view=by_order_id&order_id_query={{ delivery.order_id }}">
                                        #{{ delivery.order_id }}
                                    </a>
                                </td>
                                <td>
                                    <ul class="list-unstyled mb-0">
                                        {% if delivery.items.items is defined and delivery.items.items is not empty %}
                                            <li>Paket:</li>
                                            <ul class="list-unstyled ps-3 mb-1">
                                                {% for item in delivery.items.items %}
                                                    <li>{{ item.quantity }}x {{ item.package_name | default('N/A') }}{% if item.price is defined and item.price is not null %} <span class="text-muted">@ {{ item.price | number_format(0, ',', '.') }}</span>{% else %}{% endif %}</li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}

                                        {% set valid_additional_items = [] %}
                                        {% if delivery.items.additional_items is defined and delivery.items.additional_items is not empty %}
                                            {% for add_item in delivery.items.additional_items %}
                                                {% if add_item.item_name is defined and add_item.item_name is not null and add_item.item_name != '' and add_item.item_name != 'N/A' %}
                                                    {% set valid_additional_items = valid_additional_items|merge([add_item]) %}
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}

                                        {% if valid_additional_items is not empty %}
                                            <li>Tambahan:</li>
                                            <ul class="list-unstyled ps-3 mb-1">
                                                {% for add_item in valid_additional_items %}
                                                    <li>{{ add_item.quantity | default(1) }}x {{ add_item.item_name }}{% if add_item.price is defined and add_item.price is not null and add_item.price > 0 %} <span class="text-muted">@ {{ add_item.price | number_format(0, ',', '.') }}</span>{% endif %}</li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}
                                        <li class="mt-1 text-muted"><strong>Subtotal Items: {{ delivery.subtotal_harga | number_format(0, ',', '.') }}</strong></li>
                                    </ul>
                                    {# Fallback for when there are absolutely no items, including no subtotal to display meaningful info from #}
                                    {% if (delivery.items.items is empty or delivery.items.items is not defined or delivery.items.items | length == 0) and
                                           (delivery.items.additional_items is empty or delivery.items.additional_items is not defined or delivery.items.additional_items | length == 0) and
                                           (delivery.subtotal_harga is null or delivery.subtotal_harga == 0) %}
                                        <span class="text-muted">- No items -</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if delivery.kitchen_note and delivery.kitchen_note is not empty %}
                                        <small class="d-block"><strong>Dapur:</strong> {{ delivery.kitchen_note }}</small>
                                    {% endif %}
                                    {% if delivery.courier_note and delivery.courier_note is not empty %}
                                        <small class="d-block"><strong>Kurir:</strong> {{ delivery.courier_note }}</small>
                                    {% endif %}
                                    {% if (delivery.kitchen_note is empty or delivery.kitchen_note is null) and (delivery.courier_note is empty or delivery.courier_note is null) %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ delivery.courier_name | default('N/A') }}</td>
                                <td>{{ delivery.payment_method | replace({'_': ' '}) | title | default('N/A') }}</td>
                                <td>{{ delivery.ongkir | number_format(0, ',', '.') }}</td>
                                <td>{{ (delivery.subtotal_harga + delivery.ongkir) | number_format(0, ',', '.') }}</td>
                                <td>
                                    {% set status_text = delivery.status | default('N/A') %}
                                    {% set status_lower_for_class = status_text | lower | trim %}
                                    {% set dot_badge_color_class = 'bg-secondary' %} {# Default color #}

                                    {% if status_lower_for_class == 'selesai' or status_lower_for_class == 'completed' %}
                                        {% set dot_badge_color_class = 'bg-success' %}
                                    {% elseif status_lower_for_class == 'pending' or status_lower_for_class == 'terjadwal' %}
                                        {% set dot_badge_color_class = 'bg-warning' %}
                                    {% elseif status_lower_for_class == 'dibatalkan' or status_lower_for_class == 'cancelled' or status_lower_for_class == 'canceled' %}
                                        {% set dot_badge_color_class = 'bg-danger' %}
                                    {% elseif status_lower_for_class == 'dalam perjalanan' or status_lower_for_class == 'in progress' or status_lower_for_class == 'otw' %}
                                        {% set dot_badge_color_class = 'bg-info' %}
                                    {% endif %}
                                    <span class="badge {{ dot_badge_color_class }} me-1"></span>{{ status_text | replace({'_': ' '}) | title }}
                                </td>
                                <td>
                                    <div class="btn-list flex-nowrap">
                                        <button class="btn btn-sm btn-icon edit-delivery-btn" data-delivery-id="{{ delivery.delivery_id }}" title="Edit Pengiriman">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-pencil" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" /><path d="M13.5 6.5l4 4" /></svg>
                                        </button>
                                        <button class="btn btn-sm btn-icon delete-delivery-btn" data-delivery-id="{{ delivery.delivery_id }}" title="Hapus Pengiriman">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-trash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7l16 0" /><path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" /></svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% elseif deliveries_for_today is defined and deliveries_for_today is empty %}
            {# Case where controller passed empty array for today's deliveries #}
            <div class="empty-state-card text-center py-5">
                <div style="width: 200px; height: 200px; margin: 0 auto 1rem auto;">
                    {% include 'svg/bird.svg.twig' %}
                </div>
                <p class="mt-3">Tidak ada pengiriman yang dijadwalkan untuk tanggal <strong id="searched_date_display_ssr">{{ default_date | date("d M Y") }}</strong>.</p>
                <p class="text-muted">Anda bisa mencoba mencari tanggal lain.</p>
            </div>
        {% else %}
            {# Initial state if deliveries_for_today is not defined (e.g. error or not 'by_date' view)
               or if JS is expected to load this content.
               However, if view is 'by_date', controller should define deliveries_for_today.
               So this state is more of a fallback or for when JS takes over.
            #}
            <div class="empty-state-card text-center py-5" id="initial-by-date-empty-state">
                <div style="width: 200px; height: 200px; margin: 0 auto 1rem auto;">
                    {% include 'svg/bird.svg.twig' %}
                </div>
                <p class="mt-3">Pilih tanggal di atas untuk melihat daftar pengiriman.</p>
            </div>
        {% endif %}
    {% endif %}
    {# JavaScript will replace content within delivery_date_search_results_container if a new date is searched client-side #}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% include 'confirmation-modal.html.twig' with {
    'id': 'deleteDeliveryConfirmModal',
    'title': 'Konfirmasi Hapus Pengiriman',
    'message': 'Apakah Anda yakin ingin menghapus data pengiriman ini?',
    'confirmText': 'Ya, Hapus'
} %}

{# Edit Order Modal #}
<div class="modal fade" id="editOrderModal" tabindex="-1" aria-labelledby="editOrderModalTitle" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable"> {# modal-lg for wider, modal-dialog-scrollable if content might be long #}
    <div class="modal-content">
      <form id="edit-form">
        <div class="modal-header">
          <h5 class="modal-title" id="editOrderModalTitle">Edit Order</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {# Display area for general errors related to loading or saving #}
          <div id="edit-modal-error-display" class="alert alert-danger" style="display: none;"></div>

          <div class="mb-3">
            <label for="delivery-date-input" class="form-label">Tanggal Delivery</label>
            <input type="text" id="delivery-date-input" name="tanggal" class="form-control" placeholder="Pilih tanggal">
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="kurir-select" class="form-label">Kurir</label>
              <select id="kurir-select" name="kurir_id" class="form-select"></select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="ongkir-input" class="form-label">Ongkir</label>
              <input class="form-control" type="number" id="ongkir-input" name="ongkir" step="1000" min="0">
            </div>
          </div>

          <h6 class="mt-4">Paket Item:</h6>
          <div id="package-fields-container">
            {# Package items will be dynamically inserted here by JavaScript #}
          </div>
          <button type="button" id="add-package-item-btn" class="btn btn-sm btn-outline-primary mb-3">Tambah Paket</button>

          <h6 class="mt-4">Item Tambahan:</h6>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="item-tambahan-input" class="form-label">Nama Item Tambahan</label>
              <input class="form-control" type="text" id="item-tambahan-input" name="item_tambahan">
            </div>
            <div class="col-md-6 mb-3">
              <label for="harga-tambahan-input" class="form-label">Harga Item Tambahan</label>
              <input class="form-control" type="number" id="harga-tambahan-input" name="harga_tambahan" step="500" min="0">
            </div>
          </div>
          <div class="mb-3">
            <label for="harga-modal-tambahan-input" class="form-label">Modal Item Tambahan</label>
            <input class="form-control" type="number" id="harga-modal-tambahan-input" name="harga_modal_tambahan" step="500" min="0">
          </div>

          <h6 class="mt-4">Catatan Harian (untuk seluruh pengiriman di tanggal ini):</h6>
          <div class="mb-3">
            <label for="daily-kitchen-note" class="form-label">Catatan Dapur (Harian)</label>
            <textarea id="daily-kitchen-note" name="daily_kitchen_note" class="form-control" rows="2" placeholder="Catatan umum untuk dapur di hari ini..."></textarea>
          </div>
          <div class="mb-3">
            <label for="daily-courier-note" class="form-label">Catatan Kurir (Harian)</label>
            <textarea id="daily-courier-note" name="daily_courier_note" class="form-control" rows="2" placeholder="Catatan umum untuk kurir di hari ini..."></textarea>
          </div>

          {# Display for overall total, calculated by JS #}
          <div class="mb-3 mt-4">
            <label for="overall-total-display" class="form-label fw-bold">Perkiraan Total Harga Pengiriman Ini</label>
            <input type="text" id="overall-total-display" class="form-control fs-5" readonly style="font-weight: bold;">
          </div>

          {# Optional: Display area for order-level notes if needed - this element should exist if JS tries to use it #}
          <div class="mb-3" id="order-notes-container" style="display: none;"> {# Hidden by default, JS can show if notes exist #}
              <label for="order-notes-display" class="form-label">Catatan Pesanan (Order)</label>
              <textarea id="order-notes-display" class="form-control" readonly rows="2"></textarea>
          </div>

        </div> {# End of modal-body #}
      </form> {# Form ends here, after modal-body #}
      <div class="modal-footer"> {# Footer is OUTSIDE the form tag #}
        <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" id="submit-btn" class="btn btn-primary">Simpan Perubahan</button> {# type="button" #}
      </div>
    </div>
  </div>
</div>

<!-- Modal Create New Order -->
<div class="modal modal-blur fade" id="modal-add-order" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-fullscreen-md-down" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Input Pesanan Baru</h5>
                <button type="button" class="btn-close modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                {% include 'partials/_order_form_partial.html.twig' with { show_submit_button: false } %}
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-link link-secondary" data-bs-dismiss="modal">Batal</a>
                <button type="submit" class="btn btn-primary ms-auto" form="order-form">
                    {% include 'svg/check.svg.twig' %}
                    Simpan Pesanan
                </button>
            </div>

        </div>
    </div>
</div>

{% include 'order-confirmation.html.twig' %}

{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script src="/js/flatpickr.min.js"></script>
  <script src="/js/flatpickr-l10n/id.js"></script>
  <script src="/js/awesomplete.min.js"></script>
  <script type="module" src="/js/app/orders-page.js?v={{ 'now'|date('U') }}"></script>
  <script type="module" src="/js/app/order.js?v={{ 'now'|date('U') }}"></script>
  <script type="module">
    import { initialize as initOrder, fetchCustomers, resetForm } from '/js/app/order.js';
    document.addEventListener('DOMContentLoaded', () => {
      initOrder(); // Initialize the order form logic

      const orderModal = document.getElementById('modal-add-order');
      if (orderModal) {
        orderModal.addEventListener('shown.bs.modal', () => {
          console.log('Order modal shown on orders-page, fetching customers.');
          fetchCustomers();
        });
        orderModal.addEventListener('hidden.bs.modal', () => {
          console.log('Order modal hidden on orders-page, resetting form.');
          resetForm();
        });
      }
    });
  </script>
{% endblock %}
