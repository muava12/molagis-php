{% extends "base.html.twig" %}

{% block title %}{{ title | default("Riwayat Pengiriman Pelanggan") }}{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <link rel="stylesheet" href="/css/flatpickr.min.css">
  <link rel="stylesheet" href="/css/awesomplete.min.css">
  <link rel="stylesheet" href="/css/app/awesomplete.css?v={{ 'now'|date('U') }}" />
  <link rel="stylesheet" href="/css/app/orders-page.css?v={{ 'now'|date('U') }}">
  <link rel="stylesheet" href="/css/app/input-order.css?v={{ 'now'|date('U') }}">
{% endblock %}

{% block content %}
<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <h2 class="page-title">
          {{ title | default("Riwayat Pengiriman Pelanggan") }}
        </h2>
      </div>
      <div class="col-auto ms-auto d-print-none">
        <div class="btn-list">
          <!-- Tombol Create new order - Desktop -->
          <a href="#" class="btn btn-primary btn-5 d-none d-sm-inline-block" data-bs-toggle="modal" data-bs-target="#modal-add-order">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-shopping-cart-plus">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M4 19a2 2 0 1 0 4 0a2 2 0 0 0 -4 0"/>
                  <path d="M12.5 17h-6.5v-14h-2"/>
                  <path d="M6 5l14 1l-.86 6.017m-2.64 .983h-10.5"/>
                  <path d="M16 19h6"/>
                  <path d="M19 16v6"/>
              </svg>
              Input Pesanan
          </a>
          <!-- Tombol Create new order - Mobile -->
          <a href="#" class="btn btn-primary btn-6 d-sm-none btn-icon" data-bs-toggle="modal" data-bs-target="#modal-add-order" aria-label="Create new report">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-shopping-cart-plus">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M4 19a2 2 0 1 0 4 0a2 2 0 0 0 -4 0"/>
                  <path d="M12.5 17h-6.5v-14h-2"/>
                  <path d="M6 5l14 1l-.86 6.017m-2.64 .983h-10.5"/>
                  <path d="M16 19h6"/>
                  <path d="M19 16v6"/>
              </svg>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="page-body">
  <div class="container-xl">
    <div class="card">
      <div class="card-header">
  <h3 class="card-title d-flex align-items-center">
    {% if selected_customer_name and selected_customer_name is not empty %}
      {# Ensure selected_customer_id is available in this template context.
         If it's not, this might render incorrectly or throw an error.
         Assuming selected_customer_id holds the customer's ID. #}
      <span class="avatar avatar-sm me-2" style="background-image: url(https://api.dicebear.com/9.x/avataaars-neutral/svg?seed={{ selected_customer_id | default('defaultSeed') }}&scale=90&backgroundColor=ae5d29,d08b5b,edb98a,fd9841,ffdbb4,f8d25c&backgroundRotation=0,360,50,40,80,110&eyebrows=angryNatural,default,defaultNatural,flatNatural,raisedExcited,raisedExcitedNatural,sadConcerned,sadConcernedNatural,unibrowNatural,upDown,upDownNatural,angry&eyes=cry,default,eyeRoll,happy,side,squint,surprised,wink,winkWacky&mouth=concerned,default,disbelief,eating,grimace,sad,screamOpen,serious,smile,tongue,twinkle);"></span>
      {{ selected_customer_name }}
    {% else %}
      Manajemen Pesanan
    {% endif %}
  </h3>
        <div class="ms-auto">
          <nav class="nav nav-segmented" role="tablist" id="orders-view-tabs" style="visibility: hidden;">
              <button type="button" class="nav-link" id="tab-by-name-button" data-bs-toggle="tab" data-bs-target="#pane-by-name" role="tab" aria-controls="pane-by-name" aria-selected="false">
                  <!-- SVG for Users icon -->
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-users nav-link-icon icon-2">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" />
                    <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                    <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                    <path d="M21 21v-2a4 4 0 0 0 -3 -3.85" />
                  </svg>
                  <span class="d-none d-sm-inline">By Name</span>
              </button>
              <button type="button" class="nav-link" id="tab-by-date-button" data-bs-toggle="tab" data-bs-target="#pane-by-date" role="tab" aria-controls="pane-by-date" aria-selected="false">
                  <!-- SVG for Calendar icon -->
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon nav-link-icon icon-2">
                    <path d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z"></path>
                    <path d="M16 3v4"></path>
                    <path d="M8 3v4"></path>
                    <path d="M4 11h16"></path>
                    <path d="M11 15h1"></path>
                    <path d="M12 15v3"></path>
                  </svg>
                  <span class="d-none d-sm-inline">By Date</span>
              </button>
              {# Example of a disabled tab as in user's reference - adapt if needed, or remove if not applicable #}
              {# <button type="button" class="nav-link disabled" role="tab" data-bs-toggle="tab" aria-selected="false" aria-disabled="true" tabindex="-1">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon nav-link-icon icon-2">
                  </svg>
                  Other (Disabled)
              </button> #}
          </nav>
        </div>
      </div>
      {# New Control Bar - Below the card-header with tabs, but before the card-body with tab-content #}
      <div class="card-body border-bottom py-3" id="control-bar" style="visibility: hidden;">
        <div class="d-flex">
          {# This div.text-muted was the container for pagination, now removed from here. #}
          <div class="ms-auto d-flex align-items-center"> {# Search Area - aligned right #}

            {# NEW GROUPING DROPDOWN START #}
            <div class="me-3">
              <label for="grouping_select" class="form-label visually-hidden">Group By</label>
              <select class="form-select" id="grouping_select" style="width: auto;">
                  <option value="none" {% if current_grouping == 'none' or current_grouping is null %}selected{% endif %}>No Grouping</option>
                  <option value="order_id" {% if current_grouping == 'order_id' %}selected{% endif %}>Group by Order ID</option>
              </select>
            </div>
            {# NEW GROUPING DROPDOWN END #}

            {# Form for "By Name" - initial style set by JS based on 'view' variable #}
            <form method="GET" action="/orders" class="mb-0 me-2" id="form_search_by_name" style="display: none;">
              <input type="hidden" name="view" value="by_name">
              <div class="row g-2">
                <div class="col-auto">
                  <label for="customer_search_orders" class="visually-hidden">Pelanggan</label>
                  <div class="input-icon">
                    <input type="text" id="customer_search_orders" class="form-control" placeholder="Ketik nama pelanggan..." value="">
                    <span class="input-icon-addon">
                      <!-- Default to showing the search icon -->
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
                        <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"></path>
                        <path d="M21 21l-6 -6"></path>
                      </svg>
                    </span>
                  </div>
                  <input type="hidden" name="customer_id" id="selected_customer_id_hidden" value="{{ selected_customer_id | default('') }}">
                </div>
              </div>
            </form>

            {# Form for "By Order ID" - initial style set by JS based on 'view' variable #}
            <form id="form_search_by_order_id" class="mb-0 me-2" style="display: none;">
              <input type="hidden" name="view" value="by_order_id">
              <div class="row g-2">
                <div class="col-auto">
                  <label for="order_id_search_input" class="visually-hidden">Order ID</label>
                  <input type="text" class="form-control" id="order_id_search_input" placeholder="Masukkan ID Pesanan..." value="{{ order_id_query_value | default('') }}">
                </div>
                <div class="col-auto">
                  <button type="button" class="btn btn-primary" id="order_id_search_button">Cari Order</button>
                </div>
              </div>
            </form>

            {# Form for "By Date" - initial style set by JS based on 'view' variable #}
            <form id="form_search_by_date" class="mb-0" style="display: none;">
              <input type="hidden" name="view" value="by_date">
              <div class="d-flex flex-nowrap align-items-center gap-2">
                {# Date Navigation Buttons #}
                <div class="d-flex align-items-center flex-shrink-0">
                  <button type="button" class="btn btn-icon me-2" id="date_nav_prev" title="Hari Sebelumnya">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon">
                      <path d="M15 18l-6-6 6-6"/>
                    </svg>
                  </button>
                  <button type="button" class="btn btn-icon me-2" id="date_nav_today" title="Hari Ini">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon">
                      <path d="M8 2v4"></path>
                      <path d="M16 2v4"></path>
                      <path d="M3 10h18"></path>
                      <path d="M8 14h.01"></path>
                      <path d="M12 14h.01"></path>
                      <path d="M16 14h.01"></path>
                      <path d="M8 18h.01"></path>
                      <path d="M12 18h.01"></path>
                      <rect x="3" y="4" width="18" height="18" rx="2"/>
                    </svg>
                  </button>
                  <button type="button" class="btn btn-icon me-2" id="date_nav_next" title="Hari Berikutnya">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon">
                      <path d="M9 18l6-6-6-6"/>
                    </svg>
                  </button>
                </div>
                {# Date Input - Responsive width #}
                <div class="flex-grow-1" style="min-width: 120px; max-width: 200px;">
                  <label for="delivery_date_search_input" class="visually-hidden">Tanggal Pengiriman</label>
                  <div class="input-icon w-100">
                    <input type="text" class="form-control" id="delivery_date_search_input" placeholder="Pilih tanggal..." value="{{ default_date | default('') }}">
                    <span class="input-icon-addon">
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z"></path>
                        <path d="M16 3v4"></path>
                        <path d="M8 3v4"></path>
                        <path d="M4 11h16"></path>
                        <path d="M11 15h1"></path>
                        <path d="M12 15v3"></path>
                      </svg>
                    </span>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="card-body">
        {# Loading state - will be replaced by JavaScript #}
        <div id="initial-loading-state" class="text-center py-5">
          <div class="spinner-border spinner-border-sm" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <span class="ms-2">Memuat...</span>
        </div>

        <div class="tab-content" id="orders-tab-content" style="display: none;">
          <div class="tab-pane fade" id="pane-by-name" role="tabpanel" aria-labelledby="tab-by-name-button">
            <div id="orders-by-name-content-wrapper">
                {# Content will be populated by JavaScript #}
            </div>
          </div>

          <div class="tab-pane fade" id="pane-by-order-id" role="tabpanel" aria-labelledby="tab-by-order-id-button">
            {# Order ID search form was moved to control bar #}
            <div id="order_id_search_results_container">
              {# Content will be populated by JavaScript #}
            </div>
          </div>

          <div class="tab-pane fade" id="pane-by-date" role="tabpanel" aria-labelledby="tab-by-date-button">
            {# Date search form was moved to control bar #}
            <div id="delivery_date_search_results_container">
              {# Content will be populated by JavaScript #}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% include 'confirmation-modal.html.twig' with {
    'id': 'deleteDeliveryConfirmModal',
    'title': 'Konfirmasi Hapus Pengiriman',
    'message': 'Apakah Anda yakin ingin menghapus data pengiriman ini?',
    'confirmText': 'Ya, Hapus'
} %}

{# Edit Order Modal #}
<div class="modal fade" id="editOrderModal" tabindex="-1" aria-labelledby="editOrderModalTitle" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable"> {# modal-lg for wider, modal-dialog-scrollable if content might be long #}
    <div class="modal-content">
      <form id="edit-form">
        <div class="modal-header">
          <h5 class="modal-title" id="editOrderModalTitle">Edit Order</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {# Display area for general errors related to loading or saving #}
          <div id="edit-modal-error-display" class="alert alert-danger" style="display: none;"></div>

          <div class="mb-3">
            <label for="delivery-date-input" class="form-label">Tanggal Delivery</label>
            <input type="text" id="delivery-date-input" name="tanggal" class="form-control" placeholder="Pilih tanggal">
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="kurir-select" class="form-label">Kurir</label>
              <select id="kurir-select" name="kurir_id" class="form-select"></select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="ongkir-input" class="form-label">Ongkir</label>
              <input class="form-control" type="number" id="ongkir-input" name="ongkir" step="1000" min="0">
            </div>
          </div>

          <h6 class="mt-4">Paket Item:</h6>
          <div id="package-fields-container">
            {# Package items will be dynamically inserted here by JavaScript #}
          </div>
          <button type="button" id="add-package-item-btn" class="btn btn-sm btn-outline-primary mb-3">Tambah Paket</button>

          <h6 class="mt-4">Item Tambahan:</h6>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="item-tambahan-input" class="form-label">Nama Item Tambahan</label>
              <input class="form-control" type="text" id="item-tambahan-input" name="item_tambahan">
            </div>
            <div class="col-md-6 mb-3">
              <label for="harga-tambahan-input" class="form-label">Harga Item Tambahan</label>
              <input class="form-control" type="number" id="harga-tambahan-input" name="harga_tambahan" step="500" min="0">
            </div>
          </div>
          <div class="mb-3">
            <label for="harga-modal-tambahan-input" class="form-label">Modal Item Tambahan</label>
            <input class="form-control" type="number" id="harga-modal-tambahan-input" name="harga_modal_tambahan" step="500" min="0">
          </div>

          <h6 class="mt-4">Catatan Harian (untuk seluruh pengiriman di tanggal ini):</h6>
          <div class="mb-3">
            <label for="daily-kitchen-note" class="form-label">Catatan Dapur (Harian)</label>
            <textarea id="daily-kitchen-note" name="daily_kitchen_note" class="form-control" rows="2" placeholder="Catatan umum untuk dapur di hari ini..."></textarea>
          </div>
          <div class="mb-3">
            <label for="daily-courier-note" class="form-label">Catatan Kurir (Harian)</label>
            <textarea id="daily-courier-note" name="daily_courier_note" class="form-control" rows="2" placeholder="Catatan umum untuk kurir di hari ini..."></textarea>
          </div>

          {# Display for overall total, calculated by JS #}
          <div class="mb-3 mt-4">
            <label for="overall-total-display" class="form-label fw-bold">Perkiraan Total Harga Pengiriman Ini</label>
            <input type="text" id="overall-total-display" class="form-control fs-5" readonly style="font-weight: bold;">
          </div>

          {# Optional: Display area for order-level notes if needed - this element should exist if JS tries to use it #}
          <div class="mb-3" id="order-notes-container" style="display: none;"> {# Hidden by default, JS can show if notes exist #}
              <label for="order-notes-display" class="form-label">Catatan Pesanan (Order)</label>
              <textarea id="order-notes-display" class="form-control" readonly rows="2"></textarea>
          </div>

        </div> {# End of modal-body #}
      </form> {# Form ends here, after modal-body #}
      <div class="modal-footer"> {# Footer is OUTSIDE the form tag #}
        <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" id="submit-btn" class="btn btn-primary">Simpan Perubahan</button> {# type="button" #}
      </div>
    </div>
  </div>
</div>

<!-- Modal Create New Order -->
<div class="modal modal-blur fade" id="modal-add-order" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-fullscreen-md-down" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Input Pesanan Baru</h5>
                <button type="button" class="btn-close modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                {% include 'partials/_order_form_partial.html.twig' with { show_submit_button: false } %}
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-link link-secondary" data-bs-dismiss="modal">Batal</a>
                <button type="submit" class="btn btn-primary ms-auto" form="order-form">
                    {% include 'svg/check.svg.twig' %}
                    Simpan Pesanan
                </button>
            </div>

        </div>
    </div>
</div>

{% include 'order-confirmation.html.twig' %}

{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script src="/js/flatpickr.min.js"></script>
  <script src="/js/flatpickr-l10n/id.js"></script>
  <script src="/js/awesomplete.min.js"></script>
  <script type="module" src="/js/app/orders-page.js?v={{ 'now'|date('U') }}"></script>
  <script type="module" src="/js/app/order.js?v={{ 'now'|date('U') }}"></script>
  <script>
    // Store customer info from SSR for JavaScript access
    {% if selected_customer_id and selected_customer_name %}
    sessionStorage.setItem('current_customer_id', '{{ selected_customer_id }}');
    sessionStorage.setItem('current_customer_name', '{{ selected_customer_name }}');
    {% endif %}
  </script>
  <script type="module">
    import { initialize as initOrder, fetchCustomers, resetForm } from '/js/app/order.js';
    document.addEventListener('DOMContentLoaded', () => {
      initOrder(); // Initialize the order form logic

      const orderModal = document.getElementById('modal-add-order');
      if (orderModal) {
        orderModal.addEventListener('shown.bs.modal', () => {
          console.log('Order modal shown on orders-page, fetching customers.');
          fetchCustomers();
        });
        orderModal.addEventListener('hidden.bs.modal', () => {
          console.log('Order modal hidden on orders-page, resetting form.');
          resetForm();
        });
      }
    });
  </script>
{% endblock %}
