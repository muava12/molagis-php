{% extends "base.html.twig" %}

{% block title %}{{ title | default("Riwayat Pengiriman Pelanggan") }}{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <link rel="stylesheet" href="/css/app/awesomplete.css" />
{% endblock %}

{% block content %}
<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <h2 class="page-title">
          {{ title | default("Riwayat Pengiriman Pelanggan") }}
        </h2>
      </div>
    </div>
  </div>
</div>

<div class="page-body">
  <div class="container-xl">
    <div class="card">
      <div class="card-header">
  <h3 class="card-title d-flex align-items-center">
    {% if selected_customer_name and selected_customer_name is not empty %}
      {# Ensure selected_customer_id is available in this template context.
         If it's not, this might render incorrectly or throw an error.
         Assuming selected_customer_id holds the customer's ID. #}
      <span class="avatar avatar-sm me-2" style="background-image: url(https://api.dicebear.com/9.x/avataaars-neutral/svg?seed={{ selected_customer_id | default('defaultSeed') }}&scale=90&backgroundColor=ae5d29,d08b5b,edb98a,fd9841,ffdbb4,f8d25c&backgroundRotation=0,360,50,40,80,110&eyebrows=angryNatural,default,defaultNatural,flatNatural,raisedExcited,raisedExcitedNatural,sadConcerned,sadConcernedNatural,unibrowNatural,upDown,upDownNatural,angry&eyes=cry,default,eyeRoll,happy,side,squint,surprised,wink,winkWacky&mouth=concerned,default,disbelief,eating,grimace,sad,screamOpen,serious,smile,tongue,twinkle);"></span>
      {{ selected_customer_name }}
    {% else %}
      Manajemen Pesanan
    {% endif %}
  </h3>
        <div class="ms-auto">
          <nav class="nav nav-segmented" role="tablist" id="orders-view-tabs">
              <button class="nav-link {{ (view == 'by_name' or view is null or view == '') ? 'active' : '' }}" id="tab-by-name-button" data-bs-toggle="tab" data-bs-target="#pane-by-name" type="button" role="tab" aria-controls="pane-by-name" aria-selected="{{ (view == 'by_name' or view is null or view == '') ? 'true' : 'false' }}">
                  <!-- SVG for List icon -->
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon nav-link-icon icon-2">
                    <path d="M9 6l11 0"></path>
                    <path d="M9 12l11 0"></path>
                    <path d="M9 18l11 0"></path>
                    <path d="M5 6l0 .01"></path>
                    <path d="M5 12l0 .01"></path>
                    <path d="M5 18l0 .01"></path>
                  </svg>
                  By Name
              </button>
              <button class="nav-link {{ view == 'by_date' ? 'active' : '' }}" id="tab-by-date-button" data-bs-toggle="tab" data-bs-target="#pane-by-date" type="button" role="tab" aria-controls="pane-by-date" aria-selected="{{ view == 'by_date' ? 'true' : 'false' }}">
                  <!-- SVG for Calendar icon -->
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon nav-link-icon icon-2">
                    <path d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z"></path>
                    <path d="M16 3v4"></path>
                    <path d="M8 3v4"></path>
                    <path d="M4 11h16"></path>
                    <path d="M11 15h1"></path>
                    <path d="M12 15v3"></path>
                  </svg>
                  By Date
              </button>
              {# Example of a disabled tab as in user's reference - adapt if needed, or remove if not applicable #}
              {# <button class="nav-link disabled" role="tab" data-bs-toggle="tab" aria-selected="false" aria-disabled="true" tabindex="-1">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon nav-link-icon icon-2">
                  </svg>
                  Other (Disabled)
              </button> #}
          </nav>
        </div>
      </div>
      {# New Control Bar - Below the card-header with tabs, but before the card-body with tab-content #}
      <div class="card-body border-bottom py-3">
        <div class="d-flex">
          {# This div.text-muted was the container for pagination, now removed from here. #}
          <div class="ms-auto d-flex align-items-center"> {# Search Area - aligned right #}

            {# NEW GROUPING DROPDOWN START #}
            <div class="me-3">
              <label for="grouping_select" class="form-label visually-hidden">Group By</label>
              <select class="form-select" id="grouping_select" style="width: auto;">
                  <option value="none" {% if current_grouping == 'none' or current_grouping is null %}selected{% endif %}>No Grouping</option>
                  <option value="order_id" {% if current_grouping == 'order_id' %}selected{% endif %}>Group by Order ID</option>
              </select>
            </div>
            {# NEW GROUPING DROPDOWN END #}

            {# Form for "By Name" - initial style set by JS based on 'view' variable #}
            <form method="GET" action="/orders" class="mb-0 me-2" id="form_search_by_name" style="display: {{ (view == 'by_name' or view is null or view == '') ? 'flex' : 'none' }};">
              <input type="hidden" name="view" value="by_name">
              <div class="row g-2">
                <div class="col-auto">
                  <label for="customer_search_orders" class="visually-hidden">Pelanggan</label>
                  <div class="input-icon">
                    <input type="text" id="customer_search_orders" class="form-control" placeholder="Ketik nama pelanggan..." value="">
                    <span class="input-icon-addon">
                      <!-- Default to showing the search icon -->
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
                        <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"></path>
                        <path d="M21 21l-6 -6"></path>
                      </svg>
                    </span>
                  </div>
                  <input type="hidden" name="customer_id" id="selected_customer_id_hidden" value="{{ selected_customer_id | default('') }}">
                </div>
              </div>
            </form>

            {# Form for "By Order ID" - initial style set by JS based on 'view' variable #}
            <form id="form_search_by_order_id" class="mb-0 me-2" style="display: {{ view == 'by_order_id' ? 'flex' : 'none' }};">
              <input type="hidden" name="view" value="by_order_id">
              <div class="row g-2">
                <div class="col-auto">
                  <label for="order_id_search_input" class="visually-hidden">Order ID</label>
                  <input type="text" class="form-control" id="order_id_search_input" placeholder="Masukkan ID Pesanan..." value="{{ order_id_query_value | default('') }}">
                </div>
                <div class="col-auto">
                  <button type="button" class="btn btn-primary" id="order_id_search_button">Cari Order</button>
                </div>
              </div>
            </form>

            {# Form for "By Date" - initial style set by JS based on 'view' variable #}
            <form id="form_search_by_date" class="mb-0" style="display: {{ view == 'by_date' ? 'show' : 'none' }};">
              <input type="hidden" name="view" value="by_date">
              <div class="row g-2">
                <div class="col-auto">
                  <label for="delivery_date_search_input" class="visually-hidden">Tanggal Pengiriman</label>
                  <input type="text" class="form-control" id="delivery_date_search_input" placeholder="Pilih tanggal...">
                </div>
                <div class="col-auto">
                  <button type="button" class="btn btn-primary" id="delivery_date_search_button">Tampilkan</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="tab-content" id="orders-tab-content">
          <div class="tab-pane fade {{ view == 'by_name' or view is null or view == '' ? 'show active' : '' }}" id="pane-by-name" role="tabpanel" aria-labelledby="tab-by-name-button">
            <div id="orders-by-name-content-wrapper">
                {% if selected_customer_id %}
                    {# This content is now rendered by _orders_table_partial.html.twig #}
                    {% include '_orders_table_partial.html.twig' %}
                {% else %}
                    {% if view == 'by_name' or view is null or view == '' %}
                        <div class="alert alert-info" role="alert">
                            Silakan pilih atau cari pelanggan untuk melihat riwayat pengiriman.
                        </div>
                    {% endif %}
                {% endif %}
            </div>
          </div>

          <div class="tab-pane fade {{ view == 'by_order_id' ? 'show active' : '' }}" id="pane-by-order-id" role="tabpanel" aria-labelledby="tab-by-order-id-button">
            {# Order ID search form was moved to control bar #}
            <div id="order_id_search_results_container">
              {# Search results or messages will be injected here by JavaScript #}
              {% if not order_id_query_value and view == 'by_order_id' %}
      <p class="text-muted py-5 text-center">Masukkan ID Pesanan di atas untuk memulai pencarian.</p> {# Added some padding and centering for consistency #}
    {% elseif order_id_query_value and orders_by_id_result is not empty %}
      {# This is the case where results are found and displayed #}
                {% for order in orders_by_id_result %}
                  {% if order %} {# Check if order data is not null #}
                    <div class="card mt-3">
                        <div class="card-header"><h3 class="card-title">Order Details (ID: {{ order.id }})</h3></div>
                        <div class="card-body">
                            <p><strong>Customer:</strong> {{ order.customers.nama | default('N/A') }}</p>
                            <p><strong>Order Date:</strong> {{ order.tanggal_pesan | date("d M Y") }}</p>
                            <p><strong>Total:</strong> {{ order.total_harga | number_format(0, ',', '.') }}</p>
                            <p><strong>Payment Method:</strong> {{ order.metode_pembayaran | replace({'_': ' '}) | title }}</p>
                            <p><strong>Notes:</strong> {{ order.notes | default('-') }}</p>
                        </div>
                    </div>
                  {% endif %}
                {% endfor %}
    {% elseif order_id_query_value and (orders_by_id_result is empty or orders_by_id_result is null) and view == 'by_order_id' %}
      {# This is the case where a search was made (order_id_query_value exists) but no results were found #}
      <div class="empty-state-card text-center py-5"> {# Use common class for styling #}
          {% include 'svg/bird.svg.twig' %}
          <p class="mt-3">Pencarian tidak menemukan data.</p>
      </div>
              {% endif %}
    {# Note: JavaScript might also inject content or messages here, especially if the search happens client-side after page load.
       The above Twig logic handles server-rendered states. #}
            </div>
          </div>

          <div class="tab-pane fade {{ view == 'by_date' ? 'show active' : '' }}" id="pane-by-date" role="tabpanel" aria-labelledby="tab-by-date-button">
            {# Date search form was moved to control bar #}
            <div id="delivery_date_search_results_container">
    {# Search results or messages will be injected here by JavaScript.
       This is the initial state if the view is 'by_date' and JS hasn't loaded data yet. #}
              {% if view == 'by_date' %}
      <div class="empty-state-card text-center py-5"> {# Use common class for styling #}
          {% include 'svg/bird.svg.twig' %}
          <p class="mt-3">Pilih tanggal di atas untuk melihat daftar pengiriman.</p>
      </div>
              {% endif %}
    {# JavaScript will replace this content or hide it when it fetches and displays actual data or a specific "no results for this date" message. #}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% include 'confirmation-modal.html.twig' with {
    'id': 'deleteDeliveryConfirmModal',
    'title': 'Konfirmasi Hapus Pengiriman',
    'message': 'Apakah Anda yakin ingin menghapus data pengiriman ini?',
    'confirmText': 'Ya, Hapus'
} %}

{# Edit Order Modal #}
<div class="modal fade" id="editOrderModal" tabindex="-1" aria-labelledby="editOrderModalTitle" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable"> {# modal-lg for wider, modal-dialog-scrollable if content might be long #}
    <div class="modal-content">
      <form id="edit-form">
        <div class="modal-header">
          <h5 class="modal-title" id="editOrderModalTitle">Edit Order</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {# Display area for general errors related to loading or saving #}
          <div id="edit-modal-error-display" class="alert alert-danger" style="display: none;"></div>

          <div class="mb-3">
            <label for="delivery-date-input" class="form-label">Tanggal Delivery</label>
            <input type="text" id="delivery-date-input" name="tanggal" class="form-control" placeholder="Pilih tanggal">
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="kurir-select" class="form-label">Kurir</label>
              <select id="kurir-select" name="kurir_id" class="form-select"></select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="ongkir-input" class="form-label">Ongkir</label>
              <input class="form-control" type="number" id="ongkir-input" name="ongkir" step="1000" min="0">
            </div>
          </div>

          <h6 class="mt-4">Paket Item:</h6>
          <div id="package-fields-container">
            {# Package items will be dynamically inserted here by JavaScript #}
          </div>
          <button type="button" id="add-package-item-btn" class="btn btn-sm btn-outline-primary mb-3">Tambah Paket</button>

          <h6 class="mt-4">Item Tambahan:</h6>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="item-tambahan-input" class="form-label">Nama Item Tambahan</label>
              <input class="form-control" type="text" id="item-tambahan-input" name="item_tambahan">
            </div>
            <div class="col-md-6 mb-3">
              <label for="harga-tambahan-input" class="form-label">Harga Item Tambahan</label>
              <input class="form-control" type="number" id="harga-tambahan-input" name="harga_tambahan" step="500" min="0">
            </div>
          </div>
          <div class="mb-3">
            <label for="harga-modal-tambahan-input" class="form-label">Modal Item Tambahan</label>
            <input class="form-control" type="number" id="harga-modal-tambahan-input" name="harga_modal_tambahan" step="500" min="0">
          </div>

          <h6 class="mt-4">Catatan Harian (untuk seluruh pengiriman di tanggal ini):</h6>
          <div class="mb-3">
            <label for="daily-kitchen-note" class="form-label">Catatan Dapur (Harian)</label>
            <textarea id="daily-kitchen-note" name="daily_kitchen_note" class="form-control" rows="2" placeholder="Catatan umum untuk dapur di hari ini..."></textarea>
          </div>
          <div class="mb-3">
            <label for="daily-courier-note" class="form-label">Catatan Kurir (Harian)</label>
            <textarea id="daily-courier-note" name="daily_courier_note" class="form-control" rows="2" placeholder="Catatan umum untuk kurir di hari ini..."></textarea>
          </div>

          {# Display for overall total, calculated by JS #}
          <div class="mb-3 mt-4">
            <label for="overall-total-display" class="form-label fw-bold">Perkiraan Total Harga Pengiriman Ini</label>
            <input type="text" id="overall-total-display" class="form-control fs-5" readonly style="font-weight: bold;">
          </div>

          {# Optional: Display area for order-level notes if needed - this element should exist if JS tries to use it #}
          <div class="mb-3" id="order-notes-container" style="display: none;"> {# Hidden by default, JS can show if notes exist #}
              <label for="order-notes-display" class="form-label">Catatan Pesanan (Order)</label>
              <textarea id="order-notes-display" class="form-control" readonly rows="2"></textarea>
          </div>

        </div> {# End of modal-body #}
      </form> {# Form ends here, after modal-body #}
      <div class="modal-footer"> {# Footer is OUTSIDE the form tag #}
        <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" id="submit-btn" class="btn btn-primary">Simpan Perubahan</button> {# type="button" #}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script src="/js/awesomplete.min.js"></script>
  <script type="module" src="/js/app/orders-page.js?v={{ 'now'|date('U') }}"></script>
{% endblock %}
